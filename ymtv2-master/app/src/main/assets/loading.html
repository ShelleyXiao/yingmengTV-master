<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"> 
<meta name="viewport" content="height=device-height,initial-scale=1, maximum-scale=1">
<title></title>

<!-- <script src="adController_android.js"></script> -->
<style type="text/css">
* { padding:0; margin:0;}
body{
margin:0px auto;
}
.poster {
    vertical-align:middle;
    width:100%;
    max-height:100%;
    max-width:100%;
    height:100%;
}
.con_div{
width: 100%;
    height:100%;
text-align:center;
vertical-align:middle;
color:#000;
}
.iframeDiv{
position:absolute;
filter:alpha(Opacity=80);
z-index:100;
width:100%;
height:100%;
}
.float_div{
position:absolute;
float:right;
z-index:100;
width:75px;
height:75px;
right:0;
top:0;
background-image:url(http://ad-cache.dopool.com/ad/AdSale/html_api/bg_video_ad_timer.png);
}
.vip_div{
position:absolute;
float:right;
z-index:100;
width:75px;
height:75px;
right:0;
top:0;
margin-right: 75px;
}
.vip_con{   
position:absolute;
z-indent:2;
left:0;
top:0;
}
.close_div{
position:absolute;
float:right;
z-index:100;
right:0;
top:0;
text-align: right;
}
.back{
position:absolute;
float:left;
z-index:100;
left:0;
top:0;
}
.timer{
color:#fff;    
position:absolute;
z-indent:2;
left:0;
top:0;
}

</style>
</head>
<body class="body">
    <div class="con_div" id="con_div">
        <div class="back" onclick="AdJsServerController.goback()" style='display:none'>
            <div id="" class="timer">
                    <img id="backImg" src="http://ad-cache.dopool.com/ad/AdSale/html_api/back_from_video_ad.png">
            </div>
        </div>
        <div id="vip_div" class="vip_div" style="display:none" >
            <a href="javascript:ClientInterface.blockAd()">
                <img id="vip_img" src="http://ad-cache.dopool.com/ad/AdSale/html_api/blockad.png">
            </a>
        </div>
        <div id="float_div" class="float_div" style='display:none'>
                <div id="timer" class="timer">5</div>
        </div>
        <div id="close" class="close_div" style='display:none'>
                <img id="close_img" onclick="AdJsServerController.closeImg()" src="http://ad-cache.dopool.com/ad/AdSale/html_api/close.png">
        </div>
        <div onclick="AdJsServerController.downloadapp()" id="iframeDiv" class="iframeDiv" style="display:none;"></div>
        <iframe id="iframe" width="100%" height="100%" style="display:none" src=""></iframe>
        <!--<img onclick="AdJsServerController.downloadapp()" id="ad_img" src="" class="poster" >-->
        <div id="ad_img_wrapper"></div>
        <img style="display:none" id="start_ad_img" src="" class="poster" >
        <input id="ad_location" type="hidden" value="">
        <input id="app_name" type="hidden" value="">
        <input id="app_iscancel" type="hidden" value="">
        <input id="location_type" type="hidden" value="">
        <input id="user_imp" type="hidden" value="">
        <input id="user_clk" type="hidden" value="">
        <input id="third_imp" type="hidden" value="">
        <input id="third_clk" type="hidden" value="">
        <input id="sm_clk" type="hidden" value="">
        <input id="orderid" type="hidden" value="">
        <input id="order_params" type="hidden" value="">
    </div>
</body>
<script>

var adtypes = {
    startloading: 'startapp',
    loading: 'pre_play',
    banner: 'banner',
    preinsert: 'interstitial'
};

try{


var $ = function (selector) {
    var obj;
    var isclass = false;
    var str = selector.substr(1);
    if(selector.indexOf(".") >= 0){
        isclass = true;
        obj = document.getElementsByClassName(str);
    }else{
        obj = document.getElementById(str);
    }
    //console.log(obj)
    var jquery = {
        "val":function(){
            if(arguments[0] != undefined){
                obj.value = arguments[0];
            }
            return obj.value;
        },
        "attr":function(){
            if(arguments.length > 1){
                obj.setAttribute(arguments[0], arguments[1])
            }
            return obj.getAttribute(arguments[0]);
        },
        "css":function(){
            if(isclass){
                for (var i = 0; i < obj.length; i++) {
                    if(arguments.length == 2){
                        obj[i].style[arguments[0]] = arguments[1]
                    }
                };
                return obj[0].style[arguments[0]];
            }else{
                if(arguments.length == 2){
                    obj.style[arguments[0]] = arguments[1]
                }
                return obj.style[arguments[0]];
            }
        },
        "html":function(){
            if(arguments[0] != undefined){
                obj.innerHTML = arguments[0];
            }
            return obj.innerHTML;

        }
    }
    return jquery;
}

var common = common || (function(){

    //Base64压缩算法js实现
    var Base64 = {
        // private property
        _keyStr : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

        // public method for encoding
        encode : function (input) {
            var output = "";
            var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
            var i = 0;

            input = Base64._utf8_encode(input);

            while (i < input.length) {

                chr1 = input.charCodeAt(i++);
                chr2 = input.charCodeAt(i++);
                chr3 = input.charCodeAt(i++);

                enc1 = chr1 >> 2;
                enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
                enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
                enc4 = chr3 & 63;

                if (isNaN(chr2)) {
                    enc3 = enc4 = 64;
                } else if (isNaN(chr3)) {
                    enc4 = 64;
                }
                output = output +
                this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
                this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);

            }
            return output;
        },
        // public method for decoding
        decode : function (input) {
            var output = "";
            var chr1, chr2, chr3;
            var enc1, enc2, enc3, enc4;
            var i = 0;
            input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");
            while (i < input.length) {
                enc1 = this._keyStr.indexOf(input.charAt(i++));
                enc2 = this._keyStr.indexOf(input.charAt(i++));
                enc3 = this._keyStr.indexOf(input.charAt(i++));
                enc4 = this._keyStr.indexOf(input.charAt(i++));

                chr1 = (enc1 << 2) | (enc2 >> 4);
                chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
                chr3 = ((enc3 & 3) << 6) | enc4;
                output = output + String.fromCharCode(chr1);
                if (enc3 != 64) {
                    output = output + String.fromCharCode(chr2);
                }
                if (enc4 != 64) {
                    output = output + String.fromCharCode(chr3);
                }
            }
            output = Base64._utf8_decode(output);
            return output;
        },
        // private method for UTF-8 encoding
        _utf8_encode : function (string) {
            string = string.replace(/\r\n/g,"\n");
            var utftext = "";
            for (var n = 0; n < string.length; n++) {
                var c = string.charCodeAt(n);
                if (c < 128) {
                    utftext += String.fromCharCode(c);
                }
                else if((c > 127) && (c < 2048)) {
                    utftext += String.fromCharCode((c >> 6) | 192);
                    utftext += String.fromCharCode((c & 63) | 128);
                }
                else {
                    utftext += String.fromCharCode((c >> 12) | 224);
                    utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                    utftext += String.fromCharCode((c & 63) | 128);
                }
            }
            return utftext;
        },

        // private method for UTF-8 decoding
        _utf8_decode : function (utftext) {
            var string = "";
            var i = 0;
            var c = c1 = c2 = 0;
            while ( i < utftext.length ) {
                c = utftext.charCodeAt(i);
                if (c < 128) {
                    string += String.fromCharCode(c);
                    i++;
                }
                else if((c > 191) && (c < 224 )) {
                    c2 = utftext.charCodeAt(i+1);
                    string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
                    i += 2;
                }
                else {
                    c2 = utftext.charCodeAt(i+1);
                    c3 = utftext.charCodeAt(i+2);
                    string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                    i += 3;
                }
            }
            return string;
        }
    }

    //Localstorage的重写
    var localstorage = {
        "getItem" : function(key){
            var info  =  AdInterface.getPhoneInfo()
            info = JSON.parse(info);
            var app_ver = info['app_ver'] !=  undefined ? info['app_ver'] : info['appver'];;
            key = app_ver + "_" + key;
            var res;
            if(typeof(AdInterface) !=  "undefined" && "getDataCache" in AdInterface){
                res = AdInterface.getDataCache(key)
                if(res == "undefined"){
                    res = undefined;
                }
            }else{
                res = locallocalstorage.getItem(key);
            }
            return res;
        },
        "setItem" : function(key, value){
            var info = AdInterface.getPhoneInfo()
            info = JSON.parse(info);
            var app_ver = info['app_ver'] !=  undefined ? info['app_ver'] : info['appver'];;
            key = app_ver + "_" + key;
            if(typeof(AdInterface) !=  "undefined" && "setDataCache" in AdInterface){
                res = AdInterface.setDataCache(key, value);
            }else{
                res = locallocalstorage.setItem(key, value);
            }
        },
        "removeItem" : function(key){
            var info = AdInterface.getPhoneInfo()
            info = JSON.parse(info);
            var app_ver = info['app_ver'] !=  undefined ? info['app_ver'] : info['appver'];;
            key = app_ver + "_" + key;
            if(typeof(AdInterface) !=  "undefined" && "removeDataCache" in AdInterface){
                AdInterface.removeDataCache(key);
            }else{
                locallocalstorage.removeItem(key);
            }
        }
    };

    var paramsToJson = function(params){
        var data = params.split("&");
        var res = {};
        for(var i=0, iLoop = data.length; i < iLoop; i++){
            var tmp = data[i].split("=");
            res[tmp[0]] = tmp[1];
        }
        return res;
    };

    //判断对象是否为空
    var isEmpty = function(obj){
        for (var name in obj){
            return false;
        }
        return true;
    };

    /**
     *
     * 往url后面添加参数,支持多个参数
     *
     * @param String url
     *
     * @param Object params
     *
     * @param Object params ...
     *
     * @return String url 返回添加完参数的url
     *
     * 用法：
     * 输入 addparams('url.com', {a: 'a'}, {b: 'b'})
     * 输出 'url.com?a=a&b=b'
     */

    var addParams = function(){

        var args = [].slice.call(arguments);

        var url = '';
        if( args[0]){
            url = /\?/.test(args[0]) ? args[0] + '&' : args[0] + '?';
        }

        var ps = [];

        for(var i = 1; i < args.length; i++){
            for(var key in args[i]){
                if(args[i].hasOwnProperty(key)){
                    ps.push(encodeURIComponent(key) + '=' + encodeURIComponent(args[i][key]));
                }
            }
        }

        url += ps.join('&');

        return url;
    };

    function getDate(date){
        var myDate = date ? (new Date(date)) : (new Date());

        var arr = [];
        arr.push(myDate.getFullYear());
        arr.push(myDate.getMonth() + 1);
        arr.push(myDate.getDate());

        return arr.join('-');
    }

    function isString(obj){
        return typeof obj === 'string';
    }

    function isUndefined(obj){
        return typeof obj === 'undefined' || obj === 'undefined';
    }

    function isDefined(obj){
        return !isUndefined(obj);
    }

   function checkDayNum(data, index, adDate){
        var dayNum = common.getItem("dayNum");
        var res = true;
        if(typeof(dayNum) == "string" && dayNum !== "undefined"){
            var dayNumObj = JSON.parse(dayNum);
            if(typeof(dayNumObj[adDate]) !=="undefined" ){
                var orderDayNum = dayNumObj[adDate][data[index]['ORDERID']];
                if(orderDayNum !== "undefined" && data[index]['DAY_NUM'] > 0 && orderDayNum >= data[index]['DAY_NUM']){
                    res = true;
                }else{
                    res = false;
                }
            }else{
                var dayNumStr = '{"' + adDate + '":{}}';
                common.setItem("dayNum", dayNumStr);
                res = false;
            }
        }else{
            var dayNumStr = '{"' + adDate + '":{}}';
            common.setItem("dayNum", dayNumStr);
            res = false;
        }
        return res;
    }

    function isExpired(timestamp){
        var now = (new Date()).getTime();
        var dif = timestamp ? now - timestamp : 0;
        return dif > 1000*60*30;
    }

    function appverToNum(appver){
        appver = appver.replace(".", "");
        res = appver[0] + '.' + appver.substr(1, appver.length);
        return parseFloat(res);
    }

    function extend(){
        var args = [].slice.call(arguments);
        var target = args[0] || {};
        var source = args[1];

        for(var prop in source){
            target[prop] = source[prop];
        }
        if(args.length > 2){
            args[0] = target;
            console.log('argsa=', args);
            args.splice(1, 1);
            console.log('argsb=', args);
            extend.apply(this, args);
        }

        return target;
    }

    return {
        Base64: Base64,
        getItem: localstorage.getItem,
        setItem: localstorage.setItem,
        removeItem: localstorage.removeItem,
        isEmpty: isEmpty,
        paramsToJson: paramsToJson,
        addParams: addParams,
        getDate: getDate,
        isString: isString,
        isUndefined: isUndefined,
        isDefined: isDefined,
        checkDayNum: checkDayNum,
        isExpired: isExpired,
        appverToNum: appverToNum,
        extend: extend
    };

})();

var ClientInterface = ClientInterface || (function(){

    function getPhoneInfo(){
        if(common.isDefined(AdInterface) && common.isDefined(AdInterface.getPhoneInfo)){
            return AdInterface.getPhoneInfo()
        }else{
            return HuDongJSInterface.getPhoneInfo();
        }
    }

    function getDataCache(key){
        return AdInterface.getDataCache(key);
    }

    function setDataCache(key, value){
        AdInterface.setDataCache(key, value);
    }

    function removeDataCache(key){
        AdInterface.removeDataCache(key);
    }

    function downloadApp(app_url, app_name){
        AdInterface.downloadApp(app_url, app_name);
    }

    function forceDownloadApp(app_url, app_name){
        AdInterface.forceDownloadApp(app_url, app_name);
    }

    function openNewTablet(str, url, num){
        AdInterface.openNewTablet(str, url, num);
    }

    function back(){
        AdInterface.back();
    }

    function show(tag){
        log('adtest ' + tag, 'AdInterface.show')
        AdInterface.show();
    }

    function hide(tag){
        log('adtest ' + tag, 'AdInterface.hide');
        AdInterface.hide();
    }

    function getHdtData(){
        return AdInterface.getHdtData();
    }

    function getApi(url){
        return AdInterface.getApi(url);
    }

    function noAds(tag){
        log('adtest ' + tag, 'AdInterface.noads');
        AdInterface.noAds();
    }

    function sendApi(dataApi, eventName, adParams){
        AdInterface.sendApi(dataApi, eventName, adParams);
    }

    function sendAdData(dataApi, eventName, adParams){
        try{

            if(common.isUndefined(AdInterface.sendAdData)){
                AdInterface.sendApi(dataApi, eventName, adParams);
            }else{
                AdInterface.sendAdData(dataApi, eventName, adParams);
            }

        }catch(e){
            console.log('commonjs error' , e);
            log('adtest common.js error', e.name + ':' + e.message);
        }
    }

    function getCurrentPlay(){
        return JSON.parse(AdInterface.getCurrentPlay());
    }




    function showAds(ads, tag){
        log('adtest ' + tag, 'AdInterface.showAds,ads=' + ads);
        AdInterface.showAds(ads);
    }

    function getIflyTek(){
        return AdInterface.getIflyTek();
    }

    /**
     * requestUrl
     * 异步网络请求,执行回调函数
     *
     * @param String setting 请求的参数设置,类型为JSON格式的字符串
     * {
     *
     *  url: String,        必填    请求的url ('http://url.com')
     *
     *  method: String,     必填    请求的方法，不区分大小写 ('GET' | 'POSt' | 'get' | 'post' )
     *
     *  params: Object,     选填    请求的参数, method是get的时候，已字符串的形式添加到url后面,
     *                              例如: {a: 'aaa', b: 'bbb'},转化后为'http://url.com?a=aaa&b=bbb'
     *
     *  headers: Object,    选填    请求头添加属性（'{"adid":"a1cd2ooderf4","adKey":"W5KGUA2P"}'）
     *
     *  timeout: Number,    选填    超时时间，单位秒，不传的话默认值5秒
     *
     *  success: String,    必填    请求成功的回调函数，参数为请求的返回内容
     *                              例如success值为：'request.succesCallback',
     *                              执行时候要传入返回内容request.successCallback(data)
     *
     *  error: String,      必填    请求失败的回调函数，类似于success
     *
     *  base64: Boolean     选填    (true | false)返回结果是否需要base64解密,true时需要先解密，默认值为false
     *
     * }
     */
    function requestUrl(setting){
        if(!common.isString(setting)){
            setting = JSON.stringify(setting);
        }

        //向前兼容没有requestUrl方法的版本
        if(common.isUndefined(AdInterface.requestUrl)){

            setting = JSON.parse(setting);
            console.log('no requestUrl' );

            var data = AdInterface.getApi(setting.url);

            data = setting.base64 ? common.Base64.decode(data) : data;

            if(data == 'undefined'){
                console.log('no requestUrl without data');
                _getFunctionFromString(setting['error'])(data);
            }else{
                console.log('no requestUrl with data',  setting['success']);
                _getFunctionFromString(setting['success'])(data);
            }

        }else{
            AdInterface.requestUrl(setting);
        }
    }

    //获取字符串形式的函数对象
    function _getFunctionFromString (string, scope){
        var scope = scope || window;
        var scopeSplit = string.split('.');
        for (i = 0; i < scopeSplit.length - 1; i++){
            scope = scope[scopeSplit[i]];

            if (scope == undefined) return;
        }

        return scope[scopeSplit[scopeSplit.length - 1]];
    }

    function blockAd(){
        AdInterface.backAd();
    }

    function log(tag, msg){
        AdInterface.log(tag, msg);
    }
    return {
        getPhoneInfo: getPhoneInfo,
        getDataCache: getDataCache,
        setDataCache: setDataCache,
        removeDataCache: removeDataCache,
        downloadApp: downloadApp,
        forceDownloadApp: forceDownloadApp,
        openNewTablet: openNewTablet,
        back: back,
        show: show,
        hide: hide,
        getHdtData: getHdtData,
        getApi: getApi,
        noAds: noAds,
        sendApi: sendApi,
        sendAdData: sendAdData,
        getCurrentPlay: getCurrentPlay,
        showAds: showAds,
        getIflyTek: getIflyTek,

        requestUrl: requestUrl,
        blockAd: blockAd,
        log: log
    };
})();

}catch(e){
    ClientInterface.log('adtest common.js error', e.name + ':' + e.message);
}



window.onerror = function(message, source, lineno, colno, error){
    ClientInterface.log('adtest loading', message
            + ':'
            + JSON.stringify(error)
            + ' on line '
            + lineno
            + ':'
            + colno
            + ',source='
            + source);
}


//var api_url="http://test.adapi.starschina.com/Adv/api.php";
var api_url="http://ad.dopool.com/ad/Adv/api.php";
var dataApi="http://ad-data.starschina.com";
var minAppver='6.3';
var appver;
var adDate=common.getDate();
var adInfo;
var thirdTrack={};
var show_time;

var adpage;
var clientParams;
var tag = 'loading';

//后台功能,用于前台背景控制
var AdJsServerController = {
    //adpage: ADPag对象
    //session: 该页面的唯一标示
    mainFunction : function(){
        ClientInterface.log('adtest loading', 'mainFunction start');
        adpage=ClientInterface.getCurrentPlay();
        var info=common.getItem("phoneInfo")
        if(info==undefined){
            info=ClientInterface.getPhoneInfo();
            common.setItem("phoneInfo",info);
        }

        clientParams=eval("("+info+")");
        appver=clientParams['appver'];
        var name=adpage['name'];
        var params=name!='SearchViewController'?adpage['params']:{}
        var ad_screen=adpage['screen'].split('X');
        clientParams['width']=ad_screen[0];
        clientParams['height']=ad_screen[1];

        var allads;//=ClientInterface.getDataCache("allads");
        if(typeof(allads)=="string" && allads!="undefined"){
            var allads=JSON.parse(allads);
            AdJsServerController.getadData(allads);
            ClientInterface.setDataCache("allads","undefined");
        }
        this.getLoading(clientParams,name,params);
        
        /*if(type=='contentad'){
            this.getContentAd(session,clientParams);
        }*/
    },
    getadData:function(str){
        var time=new Date();
        var timeExpires=time.getTime().toString();
        //前插屏广告
        var preInsertData=new Array();
        if(str['DATA']['ADVIEW_PREINSERT']!=undefined){
            str['DATA']['ADVIEW_PREINSERT']['ORDERID']='adview_preinsert';
            str['DATA']['ADVIEW_PREINSERT']['PARAMS']=common.paramsToJson(str['DATA']['ADVIEW_PREINSERT']['PARAMS']);
            preInsertData.push(str['DATA']['ADVIEW_PREINSERT']);
        }
        if(str['DATA']['IFLYTEK_PREINSERT']!=undefined){
            str['DATA']['IFLYTEK_PREINSERT']['ORDERID']='iflytek_preinsert';
            str['DATA']['IFLYTEK_PREINSERT']['PARAMS']=common.paramsToJson(str['DATA']['IFLYTEK_PREINSERT']['PARAMS']);
            preInsertData.push(str['DATA']['IFLYTEK_PREINSERT']);
        }
        common.setItem('preinsert',JSON.stringify({"type":"preinsert","data":preInsertData}));
        common.setItem('preinsert_expires',timeExpires);
        common.setItem('preinsert_index',"0");


        //loading 广告
        loadData={'loading':[]}; 
        if(Object.prototype.toString.call(str['DATA']['LOADING'])=='[object Object]'){
            for (var key in str['DATA']['LOADING']) {
                str['DATA']['LOADING'][key]['ORDERID']=key;
                str['DATA']['LOADING'][key]['PARAMS']=common.paramsToJson(str['DATA']['LOADING'][key]['PARAMS']);
                loadData['loading'].push(str['DATA']['LOADING'][key]);
            }
        }
        loadData['adchina']=str['DATA']['ADCHINA'];
        loadData['adchina_video']=str['DATA']['ADCHINA_VIDEO'];
        loadData['adtouch']=str['DATA']['ADTOUCH'];
        loadData['admob']=str['DATA']['ADMOB'];
        loadData['bailin_loading']=str['DATA']['BAILIN_LOADING'];
        common.setItem('loading',JSON.stringify(loadData));
        common.setItem('loading_expires',timeExpires);
        common.setItem('loading_index',"0");


        //开机图广告
        if(Object.prototype.toString.call(str['DATA']['STARTLOADING'])=='[object Object]'){
            if(str['DATA']['STARTLOADING']['ICON']!=undefined){
                var resData=str['DATA']['STARTLOADING'];
                resData['STATISTURL']=str['DATA']['STATISTURL']
                common.setItem('startloading',JSON.stringify(resData));
            }
        }
        
        var resData=str['DATA'];
    
        var bannerData=new Array();
        var dopool_banner={};
        if(!common.isEmpty(resData['BANNER_V2']) && Object.prototype.toString.call(resData['BANNER_V2'])=='[object Object]'){
            for (var key in resData['BANNER_V2']) {
                resData['BANNER_V2'][key]['ORDERID']=key;
                resData['BANNER_V2'][key]['PARAMS']=common.paramsToJson(resData['BANNER_V2'][key]['PARAMS']);
                bannerData.push(resData['BANNER_V2'][key]);
            };
        }
        dopool_banner['type']='banner';
        dopool_banner['data']=bannerData;
        common.setItem('banner',JSON.stringify(dopool_banner));
        common.setItem('banner_expires',timeExpires);
        common.setItem('banner_index',"0");
    },
    getLoading:function(clientParams,name,params){
        var data=common.getItem("loading");
        var loading_expires=common.getItem("loading_expires");
        var now=new Date().getTime();
        var dif=loading_expires!==undefined?now-loading_expires:0;
        if(data===undefined || dif>1000*60*30){
            var url = common.addParams(api_url, {a: 'getallads'}, clientParams);
            ClientInterface.log('adtest loading', 'before requestUrl;;url=' + url);
            ClientInterface.requestUrl({
                url: url,
                method: 'get',
                base64: true,
                success: 'AdJsServerController.getAdDataSuccess',
                error: 'AdJsServerController.getAdDataError'
            });
        }else{
            AdJsServerController.afterGetLoading(data);
        }
    },

    afterGetLoading: function(data){
        ClientInterface.log('adtest loading', 'afterGetLoading;;' + data.toString());

        if(!data){
            return;
        }

        if(typeof(data)=='string'){
            //data=eval('('+data+')');
            data = JSON.parse(data);
        }

        var index=parseInt(common.getItem("loading_index"));
        //var video_id=params.channel;
        var params=adpage['name']!='SearchViewController'?adpage['params']:{}
        var videoType=params.videoType;
        var video_id=(videoType=='0' || videoType=='11')?'vod':params.videoId;
        var orderid=0;
        //var show_id=clientParams['show_id'];
        ClientInterface.log('adtest loading', 'afterGetLoading length=' + data['loading'].length + ';videoid=' + video_id);
        if(data['loading'].length>0){
            var loading=data['loading'];
            var length=data['loading'].length;
            var tmp_index=index;
            if(common.getItem("loading_index")>=length || common.getItem("loading_index")==undefined){
                index=0;
            }else{
                index=parseInt(common.getItem("loading_index"));
            }
            for(var i =index; i <length; i++){
                var videoids=','+loading[i]['VIDEOIDS']+',';
                var excludevideoids=loading[i]['EXCLUDE']!=undefined?','+loading[i]['EXCLUDE']+',':"";
                if(videoids.indexOf(','+video_id+',')!==-1 || (loading[i]['VIDEOIDS']=='all' && excludevideoids.indexOf(','+video_id+',')==-1) ){
                    try 
                    {
                        var isInstall=ADJsClientController.isAppInstalled(data['loading'][i]['PACKAGE_NAME'])
                            if(isInstall){
                                continue;
                            }
                    }catch(e){
                    }
                    //判断是否满足每日点击
                    if(common.checkDayNum(loading,i,adDate)){
                        continue;
                    }
                    orderid=loading[i]['ORDERID'];
                    index=i;
                    var tmp_i=parseInt(i)+1;
                    common.setItem('loading_index',tmp_i.toString());
                    break;
                }
            }
            if(orderid===0 && tmp_index>0){
                for (var j = 0; j < index; j++) {
                    var videoids=','+loading[j]['VIDEOIDS']+',';
                    var excludevideoids=loading[j]['EXCLUDE']!=undefined?','+loading[j]['EXCLUDE']+',':"";
                    if(videoids.indexOf(','+video_id+',')!==-1 || (loading[j]['VIDEOIDS']=='all' && excludevideoids.indexOf(','+video_id+',')==-1)){
                        try 
                        {
                            var isInstall=ADJsClientController.isAppInstalled(data['loading'][j]['PACKAGE_NAME'])
                                if(isInstall){
                                    continue;
                                }
                        }catch(e){
                        }
                        //判断是否满足每日点击
                        if(common.checkDayNum(loading,j,adDate)){
                            continue;
                        }
                        orderid=loading[j]['ORDERID'];
                        index=j;
                        var tmp_j=parseInt(j)+1;
                        common.setItem('loading_index',tmp_j.toString());
                        break;
                    }
                }
            }
        }
        if(orderid===0 && data['adchina']){
            var videoids=','+data['adchina']['VIDEOIDS']+',';
            if(videoids.indexOf(','+video_id+',')!==-1  || data['adchina']['VIDEOIDS']=='all'){
                orderid='adchina';
            }
        }
        if(orderid===0 && data['adtouch']){
            var videoids=','+data['adtouch']['VIDEOIDS']+',';
            if(videoids.indexOf(','+video_id+',')!==-1  || data['adtouch']['VIDEOIDS']=='all'){
                orderid='adtouch';
            }
        }
        if(orderid===0 && data['adchina_video']!=undefined){
            var videoids=','+data['adchina_video']['VIDEOIDS']+',';
            if(videoids.indexOf(','+video_id+',')!==-1 || data['adchina_video']['VIDEOIDS']=='all'){
                orderid='adchina_video';
            }
        }
        if(orderid===0 && data['admob']!=undefined){
            var videoids=','+data['admob']['VIDEOIDS']+',';
            if(videoids.indexOf(','+video_id+',')!==-1  || data['admob']['VIDEOIDS']=='all'){
                orderid='admob';
            }
        }

        ClientInterface.log('adtest loading', 'afterGetLoading orderid=' + orderid + ';ad=' + JSON.stringify(ad));

        if(orderid!==0){
            if(orderid=="adchina"){
                //展示易传媒loading广告
                if(data['adchina']['DATA']!=undefined){
                    var icon=data['adchina']['DATA']['mtr'][0]['url'];
                    var location=data['adchina']['DATA']['cu'];
                    var orderidArr=data['adchina']['PARAMS'].split('=');
                    var orderid='adchina';
                    common.setItem("loading_index_"+orderid,data['adchina']['PARAMS']);
                    var tracking;
                    if(data['adchina']['DATA']['tracking']!=undefined){
                        tracking=data['adchina']['DATA']['tracking'];
                    }else{
                        tracking=undefined
                    }
                    var tmp={"type":"adchina","tracking":tracking,'btu':data['adchina']['DATA']['btu']}

                    var ad={
                        "type":"fullscreen",
                        "icon":icon,
                        "location":location,
                        "location_type":location_type,
                        "duration": data['loading'][index]['DURATION'],
                        "orderid":orderid,
                        "width":clientParams['width'],
                        "height":clientParams['height'],
                        "timeout":5,
                        "params":comon.paramsToJson(data['adchina']['PARAMS']),
                        "third_track":JSON.stringify(tmp)
                    }
                }else{
                    var ad={
                        "type":"adchina",
                        "timeout":"0",
                        "params":common.paramsToJson(data['adchina']['PARAMS']),
                    }
                }
            }else if(orderid=="adtouch"){
                //展示触控loading
                var ad={
                    "type":"PBADFullscreen",
                    "timeout":"0",
                    "params":common.paramsToJson(data['adtouch']['PARAMS']),
                }
            }else if(orderid=="adchina_video"){
                //易传媒视频广告
                var ad={
                    "type":"adchinaVideo",
                    "timeout":"0",
                    "params":common.paramsToJson(data['adchina_video']['PARAMS']),
                }
            }else if(orderid=="admob"){
                //google前贴片广告
                var ad={
                    "type":"admob",
                    "timeout":data['admob']['DURATION'],
                    "params":common.paramsToJson(data['admob']['PARAMS']),
                }
            }else{
                //try 
                //{
                //var isInstall=ADJsClientController.isAppInstalled(data['loading'][index]['PACKAGE_NAME'])
                //if(!isInstall){
                //判断横屏还是竖屏，已经取消竖屏广告
                /*
                if(clientParams['width']>clientParams['height']){
                */
                    var icon=data['loading'][index]['X_ICON'];
                    /*
                }else{
                    var icon=data['loading'][index]['Y_ICON'];
                }
                */
                if(clientParams['platform']!='android'){
                    var cache_icon=ADJsClientController.getCacheUrl(icon);
                    if(cache_icon!==undefined){
                        icon=cache_icon;
                    }else{
                        var paramsIcon=new Array(icon);
                        ADJsClientController.cacheUrl(paramsIcon);
                    }
                }
                ClientInterface.log('adtest loading', 'afterGetLoading icon=' + icon);
                var location=data['loading'][index]['LOCATION'];
                var location_type=data['loading'][index]['LOCATION_TYPE'];
                var app_name="";
                var app_iscancel="0";
                var lomark_ts="";
                var lomark_tc="";
                if(data['loading'][index]['PARAMS']['lomark_ts']!=undefined){
                    lomark_ts=common.Base64.decode(data['loading'][index]['PARAMS']['lomark_ts']);
                    delete data['loading'][index]['PARAMS']['lomark_ts'];
                }

                if(location!=""){
                    var aQuery = location.split("?");  //取得Get参数
                    var aGet = new Array();
                    if(aQuery.length > 1)
                    {
                        var aBuf = aQuery[1].split("&");
                        for(var i=0, iLoop = aBuf.length; i<iLoop; i++)
                        {
                            var aTmp = aBuf[i].split("=");  //分离key与Value
                            aGet[aTmp[0]] = aTmp[1];
                        }
                    }
                    if(location_type=="0"){
                        location=decodeURIComponent(aGet['location']);
                        lomark_tc=aGet['lomark_tc']!=undefined?common.Base64.decode(aGet['lomark_tc']):"";
                    }else{
                        location=decodeURIComponent(aGet['app_url']);
                        app_name=aGet['app_url_name'];
                        app_iscancel=aGet['app_iscancel'];
                    }
                }
                if( data['loading'][index]['TYPE']=='VIDEO'){
                    if(clientParams['osver']>="4.0" && data['loading'][index]['VIDEOURL_FLV']!=""){
                        var videoUrl=data['loading'][index]['VIDEOURL_FLV'];
                    }else{
                        var videoUrl=data['loading'][index]['VIDEOURL']
                    }

                    var ad={
                        //广告类型video(视频)
                        "type":"video",
                        //视频广告播放地址
                        "videoUrl":videoUrl,
                        //展示时长
                        "timeout": data['loading'][index]['DURATION'],
                        //上报展示、点击数据拼接的参数
                        "params":data['loading'][index]['PARAMS'],
                        //跳转链接
                        "location":location, 
                        //apk名称
                        "app_name":app_name,
                        //是否可以取消下载1可以、0不可以
                        "app_iscancel":app_iscancel,
                        //点击跳转类型
                        "location_type":location_type,
                        //是否跳过1可以跳过，0不可以
                        "close":data['loading'][index]['CLOSE'],
                        //点击描述
                        "hitDesc":data['loading'][index]['HITDESC'],
                        //是否可以全屏点击 1可以，0不可以
                        "fullscreen_click":data['loading'][index]['FULLSCREEN_CLICK'],
                        //第三方展示
                        "impr_url":!data['loading'][index]['IMPR_URL']?data['loading'][index]['IMPR_URL']:[], 
                        //第三方点击
                        "click_url":!data['loading'][index]['CLICK_URL']?data['loading'][index]['CLICK_URL']:[], 

                    }
                }else if(icon!=''){
                    var ad={
                        "type":"fullscreen",
                        "icon":icon,
                        "location":location,
                        "location_type":location_type,
                        "duration": data['loading'][index]['DURATION'],
                        "orderid":orderid,
                        "width":clientParams['width'],
                        "height":clientParams['height'],
                        "timeout":data['loading'][index]['DURATION'],
                        "params":data['loading'][index]['PARAMS'],
                        "app_name":app_name,
                        "app_iscancel":app_iscancel,
                        "custom_show":data['loading'][index]['CUSTOM_SHOW']==undefined?0:data['loading'][index]['CUSTOM_SHOW'],
                        "custom_click":data['loading'][index]['CUSTOM_CLICK']==undefined?0:data['loading'][index]['CUSTOM_CLICK'],
                        "lomark_ts":lomark_ts,
                        "lomark_tc":lomark_tc
                    }
                }

                // }
                //}catch(e){
                //}

            }

        }



        var loading_ad = ad;
        ClientInterface.log('adtest loading', 'loading_ad==' + JSON.stringify(ad));
        if(loading_ad){
            loading_ad['dataApi']=dataApi;//广告报数据地址
            loading_ad['params']['videoid']=adpage['params']['videoId'];

            ClientInterface.showAds(JSON.stringify(loading_ad), tag);
            if(loading_ad['type']=='fullscreen'){
                adInfo=loading_ad;
                this.init()
            }
        }else{
            ClientInterface.noAds(tag);
            ClientInterface.hide(tag);
        }
    },

    getAdDataSuccess: function(res){
        ClientInterface.log('adtest loading', 'requestUrl success' + res.toString());
        var data;
        if(typeof(res)=="string"){
            var str=eval("("+res+")");
            if(str!=undefined ){
                AdJsServerController.getadData(str);
                data=common.getItem("loading");
                AdJsServerController.afterGetLoading(data);
            }else{
                var timeExpires=time.getTime().toString();
                common.setItem('loading_expires',timeExpires);
                common.removeItem('loading');
            }
        }



    },

    getAdDataError: function(err){
        ClientInterface.log('adtest loading', 'requestUrl error=' + err);
    },

    downloadapp:function(){
        var cloud = arguments[0]?arguments[0]:0;
        var url=$("#ad_location").val();
        var app_name=$("#app_name").val();
        var app_iscancel=$("#app_iscancel").val();
        if(url==""){
            return false;
        }
        if(adInfo['lomark_tc']!=undefined){
            AdJsServerController.sendUrl(adInfo['lomark_tc']);
        }
        //$("#order_params").val()
        var adParams=adInfo['params'];
       
        var location_type=$("#location_type").val();
        if(thirdTrack['adchina_click']!=undefined){
            var script = document.createElement('script');
            script.src = thirdTrack['adchina_click']
            document.body.appendChild(script);
        }
        
        if(thirdTrack['click']!=undefined){
            for(x in thirdTrack['click']){
                var script = document.createElement('script');
                script.src = thirdTrack['click'][x]
                document.body.appendChild(script);
            }
        }

        if(thirdTrack['adchina_click']!=undefined ){
            ClientInterface.sendAdData(dataApi,'adclick',JSON.stringify(adParams));
        }


        var orderid=$("#orderid").val()
        //单设备每日点击次数
        dayNum=common.getItem("dayNum");
        if(typeof(dayNum)=="string" && dayNum!=="undefined"){
            var dayNumObj=JSON.parse(dayNum);
            if(typeof(dayNumObj[adDate][orderid])!=="undefined"){
                dayNumObj[adDate][orderid]+=1
            }else{
                dayNumObj[adDate][orderid]=1;
            }
            common.setItem("dayNum",JSON.stringify(dayNumObj));
        }else{
            var dayNumObj={}
            dayNumObj[adDate][orderid]=1;
            common.setItem("dayNum",JSON.stringify(dayNumObj));
        }
        ClientInterface.log('adtest loading', 'downloadApp location_type=' + location_type);
        if(location_type=="0" ){
            if(orderid!='adchina'){
                ClientInterface.sendAdData(dataApi,'adclick',JSON.stringify(adParams));
                this.openUrl(url,cloud)
            }else{
                this.openUrl(url,cloud)
            }
        }else{
            ClientInterface.sendAdData(dataApi,'adclick',JSON.stringify(adParams));
            if(cloud===0){
                if(app_iscancel=='1'){
                    ClientInterface.forcedDownloadApp(url,app_name);
                }else{
                    ClientInterface.downloadApp(url,app_name);
                }
            }
            
        }
        if(cloud===0){
            ClientInterface.hide(tag)
        }
    },
    openUrl:function(url,cloud){
        if(cloud>0){
            this.sendUrl(url);
        }else{
            ClientInterface.openNewTablet('',url,20000*1);    
        }
    },
    adexposure:function(adParams){
        ClientInterface.log('adtest loading', 'adexposure');
        var now=new Date().getTime();
        if(adParams['thirdshow']!=undefined){
            thirdShow=window.atob(adParams['thirdshow']);
            this.sendUrl(thirdShow)
            delete adParams['thirdshow'];
        }
        ClientInterface.sendAdData(dataApi,'adexposure',JSON.stringify(adParams));
        if(adInfo['lomark_ts']!=undefined){
            this.sendUrl(adInfo['lomark_ts']);
        }
        if(thirdTrack['adchina_show']!=undefined){
            var script = document.createElement('script');
            script.src = thirdTrack['adchina_show']
            document.body.appendChild(script);
        }
        if(thirdTrack['show']!=undefined){
            for(x in thirdTrack['show']){
                var script = document.createElement('script');
                script.src = thirdTrack['show'][x]
                document.body.appendChild(script);
                //this.sendUrl(thirdTrack['show'][x])
            }
        }
    },
    sendUrl:function(url){
        try{
            //$.getJSON(url)
            var script = document.createElement('script');
            script.src = url;
            document.body.appendChild(script);
        }catch(e){
            //console.log(e.message());
        }
    },
    init:function() {
        /*
        # 展示广告图片
        */

//        $("#con_div").css('width',adInfo['width']+"px");
//        $("#con_div").css('height',adInfo['height']+"px")
        //$("#ad_img").attr('src',adInfo['icon']);

        var img = new Image();
        img.onload = function(){
            AdJsServerController.startShow();
        };
        img.onclick = function(){
            AdJsServerController.downloadapp();
        };
        img.classList.add('poster');
        img.src = adInfo['icon'];
        document.getElementById('ad_img_wrapper').appendChild(img);

        $("#ad_location").val(adInfo['location']);
        $("#app_name").val(adInfo['app_name']);
        $("#app_iscancel").val(adInfo['app_iscancel']);

        $("#location_type").val(adInfo['location_type']);
        /*
        ## 广告倒计时 start
        */
        if(adInfo['height'] > adInfo['width']){
            $("#float_div").css('width',adInfo['height']/16+"px")
            $("#float_div").css('height',adInfo['height']/16+"px")
            $("#float_div").css('display','block')
            $("#float_div").css('margin',adInfo['height']/30+"px")

            $("#vip_div").css('width',(adInfo['height']/16)*2+"px")
            $("#vip_div").css('height',adInfo['height']/16+"px")
            $("#vip_div").css('margin',adInfo['height']/15+"px")
            $("#vip_div").css('margin-right',(adInfo['height']/30)*3.5+"px")
            $("#vip_div").css('line-height',adInfo['height']/16+"px")

            $("#vip_img").css('width',(adInfo['height']/16)*2+"px")
            $("#vip_img").css('height',adInfo['height']/16+"px")


            $("#backImg").css('width',adInfo['height']/16+"px")
            $("#backImg").css('height',adInfo['height']/16+"px")

            $(".back").css('width',adInfo['height']/16+"px")
            $(".back").css('height',adInfo['height']/16+"px")
            $(".back").css('display','block');
            $(".back").css('margin',adInfo['height']/30+"px")

            $(".timer").css('width',adInfo['height']/16+"px")
            $(".timer").css('height',adInfo['height']/16+"px")
            $(".timer").css('line-height',adInfo['height']/16+"px")
        }
        else{
            $("#float_div").css('width',adInfo['height']/8+"px")
            $("#float_div").css('height',adInfo['height']/8+"px")
            $("#float_div").css('display','block')
            $("#float_div").css('margin',adInfo['height']/15+"px")

            $("#vip_div").css('width',(adInfo['height']/8)*2+"px")
            $("#vip_div").css('height',adInfo['height']/8+"px")
            $("#vip_div").css('margin',adInfo['height']/15+"px")
            $("#vip_div").css('margin-right',(adInfo['height']/15)*3.5+"px")
            $("#vip_div").css('line-height',adInfo['height']/8+"px")

            $("#vip_img").css('width',(adInfo['height']/8)*2+"px")
            $("#vip_img").css('height',adInfo['height']/8+"px")


            $("#backImg").css('width',adInfo['height']/8+"px")
            $("#backImg").css('height',adInfo['height']/8+"px")

            $(".back").css('width',adInfo['height']/8+"px")
            $(".back").css('height',adInfo['height']/8+"px")
            $(".back").css('display','block')
            $(".back").css('margin',adInfo['height']/15+"px")

            $(".timer").css('width',adInfo['height']/8+"px")
            $(".timer").css('height',adInfo['height']/8+"px")
            $(".timer").css('line-height',adInfo['height']/8+"px")
        }


        $("#orderid").val(adInfo['orderid']);
        if(common.appverToNum(appver)>=common.appverToNum(minAppver))
        {
            $("#vip_div").css('display','block')
        }
    },
    setTimer:function(timer){
        $("#timer").html(timer);
        if(timer>0){
            setTimeout(AdJsServerController._timer(timer),1000);
        }else{
            ClientInterface.hide(tag)
        }
    },

    _timer:function(timer){
        return function()
        {
            AdJsServerController.setTimer(timer-1);
        }
    },
    goback:function(){
        ClientInterface.back();
    },
    startShow:function(){
        ClientInterface.log('adtest loading', 'startshow');

        if(adInfo==undefined){
            return false;
        }
        show_time=parseInt(adInfo['duration'])
        AdJsServerController.setTimer(show_time);
        /*
        ## 上报广告展示数据
        */
        var adexParams=adInfo['params'];
        //console.log(adexParams);
        $("#order_params").val(JSON.stringify(adexParams));
        var track=adInfo['third_track'];
        if(track!=undefined){
            track=eval("("+track+")");
            if(track['tracking']!=undefined && track['type']=='adchina'){
                for(x in track['tracking'] ){  
                    if(track['tracking'][x]['et']=='216'){
                        thirdTrack['show']=track['tracking'][x]['tku'];
                    }else if(track['tracking'][x]['et']=='214'){
                        thirdTrack['click']=track['tracking'][x]['tku'];
                    }
                }
                thirdTrack['adchina_show']=track['btu']+"&et=216";
                thirdTrack['adchina_click']=track['btu']+"&et=214&pst=20%2c30";
            }
        }
        AdJsServerController.adexposure(adexParams)

        var custom_show=adInfo['custom_show'];
        var custom_click=adInfo['custom_click'];
        if(custom_show>0){
            var rand=Math.ceil(Math.random()*1000)
            if(rand<=custom_show){
                ctime=Math.floor(Math.random()*show_time)
                setTimeout(function(){AdJsServerController.adexposure(adexParams)},1000*ctime);
            }
        }
        if(custom_click>0){
            var rand=Math.ceil(Math.random()*1000)
            if(rand<=custom_click){
                ctime=Math.floor(Math.random()*show_time)
                setTimeout(function(){downloadapp(1)},1000*ctime);
            }
        }
        ClientInterface.log("adtest loading", 'before show()');
        ClientInterface.show(tag);
        
    }

};


//返回上一页


AdJsServerController.mainFunction();
</script>
</html>
